<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/package.js | comptroller</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A simple and lightweight tool to manage your monorepo."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="comptroller"><meta property="twitter:description" content="A simple and lightweight tool to manage your monorepo."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Aldlevine/comptroller"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/comptroller.js~Comptroller.html">Comptroller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/package.js~Package.html">Package</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/events.html#events_class_eventemitter">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/builtin-modules">builtins</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/fs-extra">fs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/glob">glob</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/path.html">path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/util.html#util_util_promisify_original">promisify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/deep-equal">deep-equal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/@zdychacek/detective">detective</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://www.npmjs.com/package/format-package">format-package</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/package.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/** @type {fs} */
const fs = require(&apos;fs-extra&apos;);
/** @type {path} */
const path = require(&apos;path&apos;);
/** @type {promisify} */
const {promisify} = require(&apos;util&apos;);
/** @type {glob} */
const glob = promisify(require(&apos;glob&apos;));
/** @external {detective} https://www.npmjs.com/package/@zdychacek/detective */
const detective = require(&apos;@zdychacek/detective&apos;);
/** @external {format-package} https://www.npmjs.com/package/format-package */
const format = require(&apos;format-package&apos;);
/** @external {deep-equal} https://www.npmjs.com/package/deep-equal */
const deepEqual = require(&apos;deep-equal&apos;);

/**
 * Provides encapsulation for each local package.
 */
module.exports = class Package
{
  /**
   * Creates a new package.
   * @param {Comptroller} comptroller - The parent Comptroller instance.
   * @param {string} dir - The package&apos;s directory.
   */
  constructor (comptroller, dir)
  {
    /** @type {Comptroller} */
    this._comptroller = comptroller;

    /** @type {string} */
    this._dir = dir;

    /** @type {string} */
    this._packageJsonPath = path.join(dir, &apos;package.json&apos;);

    try {
      /** @type {object} */
      this._packageJson = require(this._packageJsonPath);

      /** @type {string} */
      this._name = this._packageJson.name;

      /** @type {object} */
      this._options = this._packageJson.comptroller || {};
    }
    catch (err)
    {
      this._packageJson = null;
      this._name = null;
      this._options = {};
    }

    /** @type {Map&lt;string, string&gt;} */
    this._dependencies = {};
  }

  /** Gets the package version */
  get version () {return this._packageJson.version}

  /**
   * Evaluates a package&apos;s dependencies
   */
  async evaluateDependencies (detectiveOpts)
  {
    return new Promise(async (res, rej) =&gt; {
      const sourcePaths = await glob(path.join(this._dir, &apos;**/*.js&apos;));
      const dependencies = {};
      for (let sourcePath of sourcePaths) {
        const sourceFile = await fs.readFilePromise(sourcePath);
        let reqs;
        try {
          reqs = detective(sourceFile, detectiveOpts);
        }
        catch (err) {
          // Parser error
          if (err.loc) {
            let {line, column} = err.loc;
            return this._comptroller.emit(&apos;error&apos;, {
              type: &apos;parse&apos;,
              err,
              file: sourcePath,
              line,
              column,
            });
          }
          // Config error
          return this._comptroller.emit(&apos;error&apos;, {
            type: &apos;config&apos;,
            config: &apos;detective&apos;,
            err,
          });
        }
        for (let req of reqs) {
          // It&apos;s a relative dep, so skip it
          if (/^\.\//.test(req)) continue;

          const split = req.split(&apos;/&apos;);
          let name = split.shift();
          if (name.charAt(0) == &apos;@&apos;) name += &apos;/&apos; + split.shift();

          dependencies[name] = {file: sourcePath, name};
        }
      }

      this._dependencies = dependencies;
      res(dependencies);
    });
  }

  /**
   * Updates a packages package.json with values found in the main package.json
   */
  async updatePackageJson ()
  {
    const {inherit} = this._options;
    const packageJson = this._packageJson;
    const comptroller = this._comptroller;
    const mainPackageJson = comptroller._packageJson;
    if (inherit) {
      for (let key of inherit) {
        if (key in mainPackageJson) {
          if (deepEqual(packageJson[key], mainPackageJson[key])) continue;
          // if (packageJson[key] == mainPackageJson[key]) continue;
          packageJson[key] = mainPackageJson[key];
          comptroller.emit(&apos;info&apos;, {
            action: &apos;update-field&apos;,
            key,
            value: mainPackageJson[key],
            packageJson: this._packageJsonPath,
          });
        }
        else {
          comptroller.emit(&apos;warn&apos;, {
            type: &apos;update-field-missing&apos;,
            key,
            packageJson: this._packageJsonPath,
          });
        }
      }
    }
  }

  /**
   * Updates a packages package.json dependencies.
   */
  async updateDependencies ()
  {
    const comptroller = this._comptroller;
    for (let depName in this._dependencies) {
      const dep = this._dependencies[depName];
      this._packageJson.dependencies = this._packageJson.dependencies || {};
      // ignore package
      if (comptroller._ignorePackages.indexOf(depName) &gt;= 0) continue;

      // local package
      if (depName in comptroller._packages) {
        const localPackage = comptroller._packages[depName];
        if (!(depName in this._packageJson.dependencies)) {
          this._packageJson.dependencies[depName] = localPackage.version;
          comptroller.emit(&apos;info&apos;, {
            action: &apos;add&apos;,
            type: &apos;local&apos;,
            file: dep.file,
            name: depName,
            version: localPackage.version,
            packageJson: this._packageJsonPath,
          });
        }
        else if (this._packageJson.dependencies[depName] !== localPackage.version) {
          this._packageJson.dependencies[depName] = localPackage.version;
          comptroller.emit(&apos;info&apos;, {
            action: &apos;update&apos;,
            type: &apos;local&apos;,
            file: dep.file,
            name: depName,
            version: localPackage.version,
            packageJson: this._packageJsonPath,
          })
        }
      }

      // remote package
      else {
        const version = comptroller._packageJson.dependencies[depName];
        if (!version) {
          comptroller.emit(&apos;warn&apos;, {
            type: &apos;missing&apos;,
            file: dep.file,
            name: depName
          });
        }
        else if (!(depName in this._packageJson.dependencies)) {
          this._packageJson.dependencies[depName] = version;
          comptroller.emit(&apos;info&apos;, {
            action: &apos;add&apos;,
            type: &apos;remote&apos;,
            file: dep.file,
            name: depName,
            version,
            packageJson: this._packageJsonPath,
          });
        }
        else if (this._packageJson.dependencies[depName] != version) {
          this._packageJson.dependencies[depName] = version;
          comptroller.emit(&apos;info&apos;, {
            action: &apos;update&apos;,
            type: &apos;remote&apos;,
            file: dep.file,
            name: depName,
            version,
            packageJson: this._packageJsonPath,
          });
        }
      }
    }
  }

  /**
   * Prunes unused dependencies from a packages package.json
   */
  async pruneDependencies ()
  {
    const comptroller = this._comptroller;
    for (let depName in this._packageJson.dependencies) {
      if (!(depName in this._dependencies)) {
        const version = this._packageJson.dependencies[depName];
        delete this._packageJson.dependencies[depName];
        comptroller.emit(&apos;info&apos;, {
          action: &apos;remove&apos;,
          name: depName,
          version,
          packageJson: this._packageJsonPath,
        });
      }
    }
  }

  /**
   * Format&apos;s package.json using {@link format-package}
   */
  async formatPackageJson ()
  {
    const comptroller = this._comptroller;
    let opts;
    if (comptroller._packageJsonOrder) {
      opts = {order: comptroller._packageJsonOrder};
    }
    return await format(this._packageJson, opts);
  }

  /**
   * Writes a package&apos;s package.json
   */
  async writePackageJson ()
  {
    await fs.writeFilePromise(this._packageJsonPath, await this.formatPackageJson());
  }
}


</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
